#!/bin/sh -e
#
#    testdrive - run today's Ubuntu development ISO, in a virtual machine
#    Copyright (C) 2009 Canonical Ltd.
#    Copyright (C) 2009 Dustin Kirkland
#
#    Authors: Dustin Kirkland <kirkland@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

PKG="testdrive"
PKGRC=$PKG"rc"

usage() {
	echo "
Usage:
  $PKG [-f FILE] [-u URL]

  $PKG is a utility that allows you to easily download the latest Ubuntu
  development release and run it in a KVM virtual machine.

  All options to this program are handled through the global configuration
  file, /etc/$PKGRC, and then the user's local configuration file,
  ~/.$PKGRC.

  Users wanting to change the behavior default configuration can make a
  copy of /etc/$PKGRC, and pass this as a parameter to $PKG.
"
	exit 1
}

# Source global configuration overrides
[ -r "/etc/$PKG.conf" ] && . "/etc/$PKG.conf"

# Source user configuration overrides
[ -r "$HOME/.$PKG"rc ] && . "$HOME/.$PKG"rc

# Handle parameters
while [ -n "$1" ]; do
	case "$1" in
		-f)
			[ -r "$2" ] && . "$2" || usage
			shift 2
		;;
		-u)
			ISO_URL="$2"
			if ! echo "$ISO_URL" | grep -qs "\.iso$"; then
				echo "ERROR: URL parameter must point to a .iso file" 1>&2
				exit 1
			fi
			shift 2
		;;
		*)
			usage
		;;
	esac
done

# Check if KVM acceleration can be used
if kvm-ok; then
	VIRT="kvm"
	echo
	echo "INFO: Using KVM for virtual machine hosting..."
	echo
else
	if which VBoxManage >/dev/null; then
		echo
		echo "WARNING: Your CPU's lack of VT will impact the performance of your VMs."
		echo "INFO: Using VirtualBox for virtual machine hosting..."
		echo
		VIRT="virtualbox"
	else
		echo
		echo "ERROR: You must have either /usr/bin/kvm or /usr/bin/VBoxManage installed."
		echo "HINT: Consider installing kvm or virtualbox-ose..."
		echo " sudo apt-get install kvm"
		echo " sudo apt-get install virtualbox-ose"
		echo
		exit 1
	fi
fi

# Set defaults where undefined
[ -z "$CACHE" ] && CACHE="$HOME/.cache/$PKG"
mkdir -p $CACHE
[ -z "$ARCH" ] && [ "$(uname -m)" = "x86_64" ] && ARCH="amd64" || ARCH="i386"
[ -z "$ISO_URL" ] && ISO_URL="rsync://cdimage.ubuntu.com/cdimage/daily-live/current/karmic-desktop-$ARCH.iso"
ISO=$(echo "$ISO_URL" | sed "s:.*/::")
PROTO=$(echo "$ISO_URL" | sed "s/:.*$//")
[ -z "$MEM" ] && [ $(grep "^MemTotal" /proc/meminfo | awk '{print $2}') -gt 1000000 ] && MEM=512 || MEM=256
[ -z "$DISK_FILE" ] && DISK_FILE=$CACHE/$PKG.img
[ -z "$DISK_SIZE" ] && DISK_SIZE=6G
[ -z "$KVM_ARGS" ] && KVM_ARGS="-usb -usbdevice tablet -net nic,model=virtio -net user -soundhw es1370"
[ -z "$VBOX_NAME" ] && VBOX_NAME="$PKG"
PATH_TO_ISO="$CACHE/$ISO"

# BUG: should check disk space availability in $CACHE dir
# Update the cache
echo
echo "INFO: Syncing the specified ISO..."
echo "      $ISO_URL"
case $PROTO in
	rsync)
		rsync -aP $ISO_URL $PATH_TO_ISO
	;;
	http|ftp)
		if which zsync >/dev/null; then
			cd $CACHE
			zsync $ISO_URL.zsync && break || true
			cd -
		fi
		# If the zsync failed, use wget
		wget $ISO_URL -O $PATH_TO_ISO
	;;
	file)
		# If the iso is on file:///, use the ISO in place
		PATH_TO_ISO=$(echo $ISO_URL | sed "s/^file:\///")
	;;
	*)
		echo "ERROR: Unsupported protocol [$PROTO]" 1>&2
		exit 1
	;;
esac

# Launch the VM
case $VIRT in
	kvm)
		echo
		echo "INFO: Creating disk image..."
		kvm-img create -f qcow2 $DISK_FILE $DISK_SIZE
		echo
		echo "INFO: Running the Virtual Machine..."
		kvm -m $MEM -cdrom $PATH_TO_ISO -drive file=$DISK_FILE,if=virtio,index=0,boot=on $KVM_ARGS
	;;
	virtualbox)
		echo
		echo "INFO: Creating disk image..."
		DISK_SIZE=$(echo "$DISK_SIZE" | sed "s/G$/000/")
		rm -f $DISK_FILE
		sed -i "\:HardDisk.*$DISK_FILE:d" $HOME/.VirtualBox/VirtualBox.xml
		VBoxManage createhd --filename $DISK_FILE --size $DISK_SIZE
		VBoxManage modifyvm $VBOX_NAME --hda none >/dev/null || true
		VBoxManage unregistervm $VBOX_NAME --delete >/dev/null || true
		rm -f $HOME/.VirtualBox/Machines/$VBOX_NAME/$VBOX_NAME.xml
		echo
		echo "INFO: Running the Virtual Machine..."
		VBoxManage createvm --register --name $VBOX_NAME
		VBoxManage modifyvm $VBOX_NAME --memory $MEM
		VBoxManage modifyvm $VBOX_NAME --hda $DISK_FILE
		VBoxManage modifyvm $VBOX_NAME --boot1 disk
		VBoxManage modifyvm $VBOX_NAME --boot2 dvd
		VBoxManage modifyvm $VBOX_NAME --nic1 nat
		VBoxManage startvm $VBOX_NAME
		VBoxManage controlvm $VBOX_NAME dvdattach $PATH_TO_ISO
		# Loop as long as this VM is running
		while true; do
			sleep 2
			if ! VBoxManage list runningvms | grep -qs "^\"$VBOX_NAME\""; then
				break
			fi
		done
	;;
	*)
		echo "ERROR: Unsupported virtualization method [$VIRT]"
	;;
esac

# Remind about cache cleanup
echo
echo "INFO: You may wish to clean up the cache directory..."
echo "      $CACHE"
ls -halF $CACHE
du -sh --apparent-size $CACHE
echo
